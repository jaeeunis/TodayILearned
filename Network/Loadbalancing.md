# Load balancing (부하분산)

> 컴퓨터 네트워크 기술의 일종으로 둘 혹은 셋이상의 중앙처리장치 혹은 저장장치와 같은 컴퓨터 자원들에게 작업을 나누는 것을 의미한다. 네트워크 사용량에 맞춰 서버의 부하를 분산시켜 로드율 증가, 서버 다운, 속도 저하 문제를 해결할 수 있다. 또한 하나의 서버에 장애가 발생해도 나머지 서버를 통해 사이트를 원활하게 운영할 수 있다.

#### Q1. 최근들어 로드밸런싱이 주목받고 있는 이유는 !?

최근 웹사이트에 접속하는 인원이 급격하게 늘어나면서, 모든 트래픽을 1대의 서버로 감다하는 것은 불가능하게 되었다. **하드웨어의 성능을 올리거나(Scale-up)**, **여러대의 서버가 나눠서 일하도록(Scale-out)** 만들어야 했기 때문이다. 하지만 하드웨어의 향상 비용은 더욱 비싸기 때문에 서버를 여러개로 운영하는 것을 택했다.

<br>

## 1. 로드 밸런서의 서버 선택 방식

#### Round Robin (라운드 로빈)

시분할 시스템을 위해 설계된 선점형 스케줄링의 하나로서, 프로세스들 사이에 우선순위를 두지 않고, **순서대로 시간다위로 할당**하는 방식이다. 서버에 들어온 요청을 순서대로 돌아가며 배정하는 방식이다. 서버와의 연결(세션)이 오래 지속되지 않는 경우에 활용하기 적합하다.

#### Least Connections (최소 연결 방식)

요청이 들어온 시점에 가장 적은 연결상태를 보이는 서버에 우선적으로 트래픽을 배분한다. 자주 세션이 길어지거나, 서버에 분배된 트래픽들이 일정하지 않은 경우에 적합하다.

#### Least Response Time (최소 응답 시간)

서버의 현재 연결 상태와 응답시간(Response Time, 서버에 요청을 보내고 최초 응답을 받을 때까지 소요되는 시간)을 모두 고려하여 트래픽을 분배한다. 가장 적은 연결 상태와 가장 짧은 응답시간을 보이는 서버에 우선적으로 로드를 배분한다. 

#### IP hash (IP 해시방식)

클라이언트의 IP주소를 특정 서버로 매핑하여 요청을 처리하는 방식이다. 사용자의 IP를 해싱해 (임의의 길이를 지닌 데이터를 고정된 길이의 데이터로 매핑) 로드를 분배하기 때문에 사용자가 항상 동일한 서버로 연결되는 것을 보장한다.

<br>

## 2. L4 / L7 로드밸런싱 

일반적으로 OSI 7계층을 기준으로 어떻게 분산하는지에 따라 종류가 나뉜다. L2, L3, L4, L4 계층이 존재하고 상위 계층으로 갈수록 섬세한 부하 분산이 가능하지만 가격이 비싸다. 하위 계층으로 갈수록 간단한 부하 분산이 가능하지만 가격이 저렴하다는 장점이 있다. 부하 한분에서는 L4 와 L4 로드밸런서가 가장 많이 사용된다. 왜냐하면 포트 정보를 바탕으로 로드를 분산하는 것이 가능하기 때문이다. **한 대의 서버에 각각 다른 포트(Port) 번호를 부여하여 다수의 서버 프로그램을 이용하는 것은 최소 L4 로드밸런서 이상에서 가능하다.**

#### Q2. L4 / L7 로드밸런싱을 가장 많이 사용하는 이유!?

한 대의 서버에 각각 다른 포트 번호를 부여하여 다수의 서버 프로그램을 이용하는 것은 최소 L4 로드밸런서 이상에서 가능하기 때문이다. 

#### Q3. Port번호 란 ?

포트는 **논리적인 접속장소**이며, 특히 인터넷 프로토콜인 **TCP/IP의 상위 프로토콜을 사용하는 응용프로그램**에서는 미리 지정된 포트 번호를 가지고 있으며, 이것들을 잘 알려진 포트번호라고 부른다. 서버 프로그램이 처음 시작되면, 지정된 포트번호로 바인드 되는데, 이 서버를 사용하려는 모든 클라이언트 프로그래믇ㄹ은 지정된 포트번호에 바인드 해야한다.

<br>

### 2-1 L4 Load balancing

> L4 로드밸런싱이란 **network transport 계층을 기반**으로 TCP, UDP, HTTP과 같은 프로토콜들의 헤더를 분석하여 그 정보를 바탕으로 부하 분산을 실시하고 거기에 더해 Source IP 혹은 Destination IP를 NAT(Network Address Transaction)하여 보낼 수 있다. Virtual IP 와 매핑한 테이블을 갖고 있기 때문에 들어오는 여러 테이블을 여러 서버에 분산시킬 수 있다.

`L4 Switch` : 4계층에 해당하는 장비로, 들어온 데이터를 로드밸런싱 해주는 장비이다. <br>
`Virtual IP` :  서버 그룹의 대표IP이다. L4 스위치가 VIP를 가지고 있으며, 서버와 통신하는 VIP를 향해 트래픽을 전송하고, L4스위치가 이 트래픽을 받아 적절하게 서버에 전송해준다. <br>
`NAT(Network Address Transaction)` : 내부 망에서는 사설 IP주소를 사용하여 통신을 하고, 외부망과의 통신시에는 NAT를 거쳐 공인 IP 주소로 자동 변환한다. 하나의 공인 IP로 여러개의 사설 IP를 사용가능하기 때문에, 공인 IP 자원의 부족 문제의 해결방안이 될 수 있다. 내부에서 외부로의 통신은 가능하지만, 외부에서 내부로의 통신은 불가능하다.

####  L4 Switching 과정

1. 브라우저에 www.naver.com 입력하면 Local DNS 는 DNS Query로 주소를 관리하는 DNS 서버에서 VIP주소를 획득한다.
2. 획득한 주소를 기반으로 L4 VIP로 http 요청하면, 서버는 작업 결과를 스위치에게 전송
3. 전송받은 작업 결과를, 스위치가 요청한 클라이언트에게 전송하면서 요청처리를 끝낸다. 

<br>

### 2-2 L7 Load balancing

> L7 로드래벌런서의 경우 **애플리케이션 계층(HTTP, FTP, SMTP)에서 로드를 분산**하기 때문에 HTTP 헤더, 쿠키 등과 같은 사용자의 요청을 기준으로 특정 서버에 트래픽을 분산하는 것이 가능하다. 쉽게 말해 패킷의 내용을 확인하고 그 내용에 따라 로드를 특정 서버에 분배하는 것이 가능하다. 또한 **특정한 패턴을 지닌 바이러스를 감지해 네트워크를 보호할 수 있으며, 비정상적인 트래픽을 필터링할 수 있어 네트워크 보안 분야에서도 활용되고 있다.**

proxcy & 로드밸런싱